<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Client Signature</title>

    <style>
      body {
        margin: 0;
        background: #3f3f3f;
        font-family: system-ui, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px;
      }

      .card {
        background: #fff;
        width: 880px;
        padding: 30px;
        border-radius: 6px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .create-btn {
        background: #f6c600;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }

      .seg {
        background: #111;
        padding: 6px;
        border-radius: 6px;
        display: inline-flex;
        gap: 6px;
        margin-bottom: 12px;
      }

      .seg button {
        background: transparent;
        border: none;
        color: #fff;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
      }

      .seg button.active {
        background: #f7d94b;
        color: #111;
      }

      .canvas-wrap {
        background: #efefef;
        border: 2px dashed rgba(0, 0, 0, 0.15);
        padding: 12px;
        border-radius: 6px;
      }

      #sig-canvas {
        width: 100%;
        height: 150px;
        background: #fff;
        border-radius: 4px;
        display: block;
      }

      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }

      .btn {
        border: 1px solid #2b69d1;
        background: transparent;
        color: #2b69d1;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
      }

      .colors span {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
        margin-left: 8px;
      }

      .blue {
        background: #2b69d1;
      }
      .red {
        background: #ff4d4f;
      }
      .black {
        background: #000;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <div class="header">
        <div>Client Signature</div>
        <button class="create-btn" id="createBtn">Create</button>
      </div>

      <div class="seg">
        <button id="drawBtn" class="active">✍ Draw</button>
        <button id="typeBtn">T Type</button>
        <button id="uploadBtn">⬆ Upload</button>
      </div>

      <div class="canvas-wrap">
        <canvas id="sig-canvas" width="600" height="150"></canvas>
      </div>

      <div id="typeControls" style="display: none; margin-top: 10px">
        <input
          id="typedName"
          placeholder="Type your name"
          style="padding: 8px; width: 300px"
        />
        <button class="btn" id="applyType">Apply</button>
      </div>

      <div id="uploadControls" style="display: none; margin-top: 10px">
        <input type="file" id="fileInput" accept="image/*" />
      </div>

      <div class="controls">
        <div>
          <button class="btn" id="clearBtn">Clear</button>
          <span class="colors">
            <span class="blue" data-color="#2b69d1"></span>
            <span class="red" data-color="#ff4d4f"></span>
            <span class="black" data-color="#000"></span>
          </span>
        </div>

        <label>
          <input type="checkbox" id="agree" />
          I agree this is my legal signature
        </label>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("sig-canvas");
      const ctx = canvas.getContext("2d");

      let drawing = false;
      let lastX = 0,
        lastY = 0;
      let color = "#000";

      /* ---------- DRAW ---------- */
      function pos(e) {
        const r = canvas.getBoundingClientRect();
        if (e.touches) e = e.touches[0];
        return {
          x: ((e.clientX - r.left) / r.width) * canvas.width,
          y: ((e.clientY - r.top) / r.height) * canvas.height,
        };
      }

      canvas.onmousedown = (e) => {
        drawing = true;
        const p = pos(e);
        lastX = p.x;
        lastY = p.y;
      };

      canvas.onmousemove = (e) => {
        if (!drawing) return;
        const p = pos(e);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        lastX = p.x;
        lastY = p.y;
      };

      window.onmouseup = () => (drawing = false);

      /* ---------- CLEAR ---------- */
      clearBtn.onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

      /* ---------- COLORS ---------- */
      document
        .querySelectorAll(".colors span")
        .forEach((c) => (c.onclick = () => (color = c.dataset.color)));

      /* ---------- MODES ---------- */
      drawBtn.onclick = () => {
        drawBtn.classList.add("active");
        typeBtn.classList.remove("active");
        uploadBtn.classList.remove("active");
        typeControls.style.display = uploadControls.style.display = "none";
      };

      typeBtn.onclick = () => {
        typeBtn.classList.add("active");
        drawBtn.classList.remove("active");
        uploadBtn.classList.remove("active");
        typeControls.style.display = "block";
        uploadControls.style.display = "none";
      };

      uploadBtn.onclick = () => {
        uploadBtn.classList.add("active");
        drawBtn.classList.remove("active");
        typeBtn.classList.remove("active");
        uploadControls.style.display = "block";
        typeControls.style.display = "none";
      };

      /* ---------- TYPE ---------- */
      applyType.onclick = () => {
        const text = typedName.value.trim();
        if (!text) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = color;
        ctx.font = '60px "Segoe Script","Brush Script MT",cursive';
        ctx.textBaseline = "middle";

        const w = ctx.measureText(text).width;
        ctx.fillText(text, (canvas.width - w) / 2, canvas.height / 2);
      };

      /* ---------- UPLOAD ---------- */
      fileInput.onchange = (e) => {
        const img = new Image();
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const scale = Math.min(600 / img.width, 150 / img.height);

          const w = img.width * scale;
          const h = img.height * scale;

          ctx.drawImage(
            img,
            (canvas.width - w) / 2,
            (canvas.height - h) / 2,
            w,
            h
          );
        };
        img.src = URL.createObjectURL(e.target.files[0]);
      };

      /* ---------- SUBMIT API ---------- */
      createBtn.onclick = () => {
        if (!agree.checked) {
          alert("Please accept agreement");
          return;
        }

        const signature = canvas.toDataURL("image/png");
        const permission = true;

        const cli = new URLSearchParams(window.location.search).get("cli");

        fetch(`http://localhost:8002/api/v1/client/signature?cli=${cli}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ signature, permission }),
        })
          .then((res) => (res.ok ? res.json() : Promise.reject(res)))
          .then(() => alert("Signature saved successfully"))
          .catch(() => alert("Signature upload failed"));
      };
    </script>
  </body>
</html>
