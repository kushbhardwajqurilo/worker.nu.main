<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Employee Monthly Hours Report</title>
  </head>

  <body style="font-family: Arial, sans-serif; background: #fff">
    <!-- DOWNLOAD BUTTON -->
    <button
      onclick="exportToExcel()"
      style="
        margin: 10px 0;
        padding: 8px 16px;
        background: #4f81bd;
        color: #fff;
        border: none;
        cursor: pointer;
      "
    >
      Download Excel
    </button>

    <table
      id="reportTable"
      style="border-collapse: collapse; width: 100%; font-size: 14px"
    >
      <!-- BLUE BAR -->
      <tr>
        <td colspan="34" style="background: #4f81bd; height: 35px"></td>
      </tr>

      <!-- TITLE -->
      <tr>
        <td></td>
        <td
          colspan="31"
          style="
            background: #d9ead3;
            color: red;
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            text-align: center;
            border: 1px solid #000;
          "
        >
          HERE IS HOURS FOR EACH EMPLOYEE FOR EVERY DAY THAT THEY WORKED WITH
          THIS PROJECT (NO SIGNATURE)
        </td>
        <td
          rowspan="3"
          style="
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            font-weight: bold;
            background: #eaf4f8;
            border: 1px solid #000;
            text-align: center;
          "
        >
          Total
        </td>
      </tr>

      <!-- DATE HEADER -->
      <tr id="dateRow">
        <td style="border: 1px solid #000"></td>
      </tr>

      <!-- DAY HEADER -->
      <tr id="dayRow">
        <td style="border: 1px solid #000"></td>
      </tr>

      <!-- BODY -->
      <tbody id="tableBody"></tbody>

      <!-- GRAND TOTAL -->
      <tfoot>
        <tr id="grandTotalRow" style="font-weight: bold; background: #f9f9f9">
          <td
            style="
              border: 1px solid #000;
              text-align: left;
              padding-left: 10px;
              font-weight: bold;
            "
          >
            GRAND TOTAL
          </td>
          <td id="grandTotalValue" style="border: 1px solid #000"></td>
        </tr>
      </tfoot>
    </table>

    <script>
      const DAYS = 31;

      async function fetchData() {
        const res = await fetch(
          "http://localhost:8002/api/v1/client/hourly-report?p_id=693aa166761f5dcf24548bbf"
        );
        const json = await res.json();
        const data = json.data;

        const months = Object.keys(data).sort();

        const dateRow = document.getElementById("dateRow");
        const dayRow = document.getElementById("dayRow");
        const tbody = document.getElementById("tableBody");
        const grandRow = document.getElementById("grandTotalRow");
        const grandValue = document.getElementById("grandTotalValue");

        let overallTotal = 0;

        const [year, month] = months[0].split("-").map(Number);

        // DATE & DAY HEADERS
        for (let d = 1; d <= DAYS; d++) {
          dateRow.innerHTML += `
            <td style="background:#eaf4f8;font-weight:bold;border:1px solid #000">${d}</td>
          `;
          const day = new Date(year, month - 1, d).toLocaleDateString("en-US", {
            weekday: "short",
          })[0];
          dayRow.innerHTML += `
            <td style="background:#eaf4f8;font-size:12px;border:1px solid #000">${day}</td>
          `;
        }

        // MONTHS DATA
        months.forEach((key) => {
          const month = data[key];

          const mRow = document.createElement("tr");
          mRow.innerHTML = `
            <td style="background:#f3f3f3;font-weight:bold;text-align:left;border:1px solid #000">
              ${month.month_name}
            </td>
            ${"<td style='border:1px solid #000'></td>".repeat(DAYS + 1)}
          `;
          tbody.appendChild(mRow);

          month.workers.forEach((worker) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td style="text-align:left;font-weight:bold;border:1px solid #000">
                ${worker.name.replace(/[_\.]/g, " ")}
              </td>
            `;

            const hoursMap = {};
            worker.daily_hours.forEach((h) => {
              const day = new Date(h.date).getDate();
              hoursMap[day] = (
                parseFloat(hoursMap[day] || 0) + parseFloat(h.hours)
              ).toFixed(2);
            });

            for (let d = 1; d <= DAYS; d++) {
              tr.innerHTML += `
                <td style="border:1px solid #000">${hoursMap[d] || ""}</td>
              `;
            }

            tr.innerHTML += `
              <td style="border:1px solid #000">${worker.total_hours}</td>
            `;
            overallTotal += parseFloat(worker.total_hours);

            tbody.appendChild(tr);
          });
        });

        for (let i = 1; i <= DAYS; i++) {
          grandRow.insertBefore(
            document.createElement("td"),
            grandValue
          ).style.border = "1px solid #000";
        }

        grandValue.innerText = overallTotal.toFixed(2);
      }

      // HTML â†’ EXCEL
      function exportToExcel() {
        const table = document.getElementById("reportTable");
        const html = table.outerHTML.replace(/ /g, "%20");

        const a = document.createElement("a");
        a.href = "data:application/vnd.ms-excel;charset=utf-8," + html;
        a.download = "project_timesheet.xlsx";
        a.click();
      }

      fetchData();
    </script>
  </body>
</html>
